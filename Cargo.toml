# =============================================================================
# FORGE KERNEL - Cargo.toml
# =============================================================================
#
# Microkernel Industrial-Grade para Redstone OS
#
# SISTEMA DE LOGS ZERO-OVERHEAD:
# - no_logs:   Release - remove 100% dos logs (custo ZERO no binário)
# - log_info:  Dev - apenas INFO, WARN, ERROR
# - log_trace: Debug - todos os níveis (padrão para desenvolvimento)
#
# Para compilar:
#   cargo build                    # Usa log_trace (padrão)
#   cargo build --features log_info --no-default-features
#   cargo build --features no_logs --no-default-features
#
# =============================================================================

[package]
name = "forge"
version = "0.0.5"
edition = "2021"
authors = ["Redstone OS Team"]
description = "Industrial-Grade Microkernel for Redstone OS"
license = "MIT"

[lib]
test = false
doctest = false
harness = false
bench = false

[[bin]]
name = "forge"
path = "src/main.rs"
test = false
harness = false
bench = false


[dependencies]
# Sincronização e Concorrência (Essencial para Mutex/Spinlocks)
spin = "0.10.0"

# Manipulação de bits segura (Essencial para Flags de GDT/Paging)
bitflags = "2.4.2"

# Acesso à memória volátil (Essencial para MMIO/Framebuffer)
volatile = "0.6.1"

# Alocador de Lista Encadeada (Para o Heap futuro - Upgrade do Bump)
linked_list_allocator = "0.10.5"

# =============================================================================
# FEATURES
# =============================================================================

[features]
# ---------------------------------------------------------------------------
# DEFAULT: Modo de desenvolvimento com logs completos
# ---------------------------------------------------------------------------
default = ["log_trace", "self_test"]

# ---------------------------------------------------------------------------
# SISTEMA DE LOGS ZERO-OVERHEAD
# ---------------------------------------------------------------------------
# Estes são MUTUAMENTE EXCLUSIVOS. Use apenas um por vez.
#
# no_logs:   PRODUÇÃO - Remove TODOS os logs do binário. Custo ZERO.
#
# log_error: PRODUÇÃO LEVE - Apenas ERROR, WARN, [OK].
#            Sem INFO/DEBUG/TRACE. Minimal output.
#
# log_info:  RELEASE - ERROR, WARN, INFO, [OK].
#            Sem DEBUG/TRACE. Bom para releases com diagnóstico básico.
#
# log_debug: DESENVOLVIMENTO - ERROR, WARN, INFO, DEBUG, [OK].
#            Sem TRACE. Ideal para desenvolvimento diário.
#
# log_trace: DEBUGGING PROFUNDO - Todos os níveis de log ativos.
#            Máxima verbosidade. Cada syscall, alocação, etc.
# ---------------------------------------------------------------------------
no_logs = []
log_error = []
log_info = []
log_debug = []
log_trace = []

# ---------------------------------------------------------------------------
# Self Test (Testes de Subsistemas)
# ---------------------------------------------------------------------------
self_test = []

# ---------------------------------------------------------------------------
# SMP (Symmetric Multi-Processing)
# ---------------------------------------------------------------------------
smp = ["tlb_shootdown", "percpu_caches"]
tlb_shootdown = []                       # TLB shootdown via IPI
percpu_caches = []                       # Per-CPU object caches

# ---------------------------------------------------------------------------
# Memops
# ---------------------------------------------------------------------------
memops_asm = [] # Usar implementação ASM (produção)
# Nota: memops_rust é o padrão quando memops_asm não está ativo

# ---------------------------------------------------------------------------
# Segurança
# ---------------------------------------------------------------------------
wx_enforcement = [] # Bloquear mapeamentos RWX (W^X policy)
guard_pages = []    # Guard pages para stacks

# ---------------------------------------------------------------------------
# Accounting
# ---------------------------------------------------------------------------
memory_accounting = [] # Tracking de memória por subsistema

# ---------------------------------------------------------------------------
# Debug avançado
# ---------------------------------------------------------------------------
alloc_stats = [] # Estatísticas de alocação
mm_trace = []    # Trace detalhado do MM

# ---------------------------------------------------------------------------
# NUMA
# ---------------------------------------------------------------------------
numa = [] # NUMA-aware allocation

# =============================================================================
# PROFILES
# =============================================================================
#
# ESTRATÉGIA DE BUILD:
# - Use release-debug como PADRÃO de desenvolvimento
# - Use release-trace para debugging profundo
# - Use release-test para CI/CD
# - Use release (ou release-minimal) para produção
#
# O perfil 'dev' é mantido para compatibilidade, mas opt-level=0 para evitar
# problemas de otimização com funções naked/asm.
# =============================================================================

[profile.dev]
panic = "abort"
opt-level = 0          # MUDANÇA: Era 1, causava bugs com naked functions
lto = false
codegen-units = 1
debug = true
strip = false
overflow-checks = true

[profile.release]
panic = "abort"
opt-level = 2            # MUDANÇA: 3 era muito agressivo, corrompia o RSP
lto = "thin"             # MUDANÇA: "true" (full) era muito agressivo
codegen-units = 1
debug = true             # MUDANÇA: Manter símbolos para debugging
strip = false            # MUDANÇA: Não strippar
debug-assertions = false # CRÍTICO: debug_assert usa formatting que gera SSE
overflow-checks = false

# -----------------------------------------------------------------------------
# RELEASE-DEBUG: Padrão para Desenvolvimento
# -----------------------------------------------------------------------------
# Otimizado o suficiente para não causar problemas, mas com símbolos debug
# e logs completos. Use com: --features log_debug
[profile.release-debug]
inherits = "release"
lto = false              # Build mais rápido
strip = false            # Mantém símbolos para GDB
debug = true             # Debug info completo
debug-assertions = false # CRÍTICO: debug_assert usa formatting que gera SSE
opt-level = 2            # Otimização moderada

# -----------------------------------------------------------------------------
# RELEASE-TRACE: Debugging Profundo
# -----------------------------------------------------------------------------
# Máxima verbosidade e verificações. Use quando algo está muito errado.
# Use com: --features log_trace
[profile.release-trace]
inherits = "release"
lto = false
strip = false
debug = true
debug-assertions = false # CRÍTICO: debug_assert usa formatting que gera SSE
opt-level = 2
overflow-checks = true   # Detecta overflows aritméticos

# -----------------------------------------------------------------------------
# RELEASE-TEST: Para CI/CD e Testes Automatizados
# -----------------------------------------------------------------------------
# Rápido de compilar, logs moderados. Use com: --features log_info
[profile.release-test]
inherits = "release"
lto = "thin"         # LTO mais rápido
strip = false
debug = false
opt-level = 2

# -----------------------------------------------------------------------------
# RELEASE-MINIMAL: Produção Final
# -----------------------------------------------------------------------------
# Zero overhead, binário mínimo. Use com: --no-default-features --features no_logs
[profile.release-minimal]
inherits = "release"
lto = true
strip = true
debug = false
opt-level = 3
